<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <script
      src="https://kit.fontawesome.com/c25aa32a21.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.0.min.js"
    ></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="style.css" />
    <title>Group 14</title>
  </head>
  <body>
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark py-3">
      <div class="container">
        <img
          width="150"
          src="img\Picture2.png"
          class="d-inline-block align-middle mr-2"
        />
        <a href="#" class="navbar-brand">VeloCity</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navmenu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navmenu">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a href="/lit.html" class="nav-link">Research</a>
            </li>
            <li class="nav-item">
              <a href="/hci.html" class="nav-link">HCi</a>
            </li>
            <li class="nav-item">
              <a href="/index.html" class="nav-link">Home</a>
            </li>
            <li class="nav-item">
              <a href="/requirements.html" class="nav-link">Requirements</a>
            </li>
            <li class="nav-item">
              <a href="/implementation.html" class="nav-link">Implementation</a>
            </li>
            <li class="nav-item">
              <a href="/requirements.html" class="nav-link">Requirements</a>
            </li>
            <li class="nav-item">
              <a href="/ui.html" class="nav-link">System Design</a>
            </li>
            <li class="nav-item">
              <a href="/system.html" class="nav-link">UI Design</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!--Showcase-->
    <section class="bg-dark text-light p-2 text-center text-sm-start">
      <div class="container">
        <div class="d-sm-flex align-items-center justify-content-between">
          <div>
            <h1>Implementation</h1>
          </div>
          <img
            class="img-fluid w-50 ms-auto d-none d-sm-block"
            src="img/undraw_personal_trainer_re_cnua.svg"
            alt=""
          />
        </div>
      </div>
    </section>

      <section>
        <div class="container aos-init aos animate" data-aos="fade-up">
          <div class="row justify-content-center mb-4">
            <h4><br /><br /><b>Main technologies</b></h4>
            <p class="lead">
              As described in our 'Research' page, our main technologies are
              <span class="m-head"><b>Xamarin</b></span
              >,<span class="m-head"><b> .NET MAUI</b></span> and<span
                class="m-head"
                ><b> C#</b></span
              >
            </p>

            <div class="row">
              <div class="d-flex justify-content-center">
                <img
                  src="img/png-transparent-xamarin-mobile-app-development-native-net-framework-c-android-blue-angle-calendar-removebg-preview.png"
                  class="tech"
                />
                <img src="img/shadow-removebg-preview.png" class="tech" />
                <img src="img/Csharp_Logo.png" class="tech" />
                <img
                  src="img/radial-icon-set-2-bluetooth-bluetooth-icon-png-clipart-thumbnail-removebg-preview.png"
                  class="tech"
                />
              </div>
            </div>
            <h4><br /><br />Dependencies & Tools</h4>
            <p class="lead">
              We also imported some plugins & dependencies in our project to
              help us test & build our project
            </p>
          </div>
        </div>
      </section>
  

  
      <section id="learn" class="p-5">
        <div class="container aos-init aos-animate" data-aos="fade-up">
          <div class="row justify-content-center mb-4">
              <div class="v-tab">
                <div class="v-content">
                  <input type="radio" name="slider" checked id="home" />
                  <input type="radio" name="slider" id="blog" />
                  <input type="radio" name="slider" id="help" />
                  <input type="radio" name="slider" id="code" />
                  <input type="radio" name="slider" id="about" />
                  <div class="list">
                    <label for="home" class="home" >
                      <span class="title">Plugin.BLE</span>
                    </label>
                    <label for="blog" class="blog">
                      <span class="title">Toolkit.Maui</span>
                    </label>
                    <label for="help" class="help">
                      <span class="title">Toolkit.Mvvm</span>
                    </label>
                    <label for="code" class="code">
                      <span class="title">Syncfusion</span>
                    </label>
                    <div class="slider"></div>
                  </div>
                  <div class="text-content">
                    <div class="home text">
                      <h5><b>Plugin.BLE</b></h5>
                      <p class="lead">
                        Given that the .NET MAUI framework does not offer in-built
                        bluetooth libraries, we had to rely and a community driven
                        plugin called <span class="m-head">Plugin.BLE</span> which
                        provided us with a reilable way to communicate with
                        Bluetooth Low Energy (BLE) devices - in our case, sensors.
                        It gave us the ability to scan, discover and connect to BLE
                        devices whilst also being able to read their
                        characteristics. In our case, we used it to discover heart
                        and cadence sensors and read their information during a
                        workout.
                        <br />
                        <br />
                      </p>
                      
                    </div>
                    <div class="blog text">
                      <h5><b>CommunityToolkit.Maui</b></h5>
                      <p class="lead">
                        
                        A plugin that offers a range of benefits to developing
                        cross-platform applications using .NET MAUI. It enables
                        greater control over handling data input, validation,
                        dialogs and animation. Furthermore, it also provides
                        platform-specific implementations and code which is helpful
                        to our project given the current scope of the app is for
                        Android devices only.
                      </p>
                  </div>
                  <div class="help text">
                    <h5><b>CommunityToolkit.Mvvm</b></h5>

                      <p class="lead">
                        Offers an implementation of the Model-View-ViewModel(MVVM)
                        architecture which helps separate concerns thus promoting
                        industry software engineering standards. It helps create
                        maintanable testable and scalable code whilst providing a
                        range of utilities for creating and binding to Viewmodel
                        classes which was primarily used in the sensor integration
                        development given several models were required to build a
                        functioning bluetooth system. With the plugin, it provides
                        more structure to an otherwise unstructured codebase.
                      </p>
                  </div>
                  <div class="code text">
                    <h5><b>Syncfusion</b></h5>

                      <p class="lead">
                        Enables the use of data visualization. The plugin offers a range of chart types, in our instance we primarily use line graphs to show how sensor data alternates throughout a workout. The charts are customizable allowing us to adjust the fonts, colors and markers.
                      </p>
                  </div>
                </div>
              </div>
            </div>
            <br />
            <br /> 
        </div>
      </section>

      <section class="p-5">
        <div class="container aos-init aos-animate" data-aos="fade-up">
            <div class="row justify-content-center mb-4">
                <h3 class="text-center"><br>Bluetooth Implementation</h3>
                <h4><b><br>Tools and Dependencies</b></h4>
                <div class="row">
                    <div class="d-flex justify-content-center">
                      <img
                        src="img/png-transparent-xamarin-mobile-app-development-native-net-framework-c-android-blue-angle-calendar-removebg-preview.png"
                        class="tech"
                      />
                      <img src="img/shadow-removebg-preview.png" class="tech" />
                      <img src="img/Csharp_Logo.png" class="tech" />
                      <img
                        src="img/radial-icon-set-2-bluetooth-bluetooth-icon-png-clipart-thumbnail-removebg-preview.png"
                        class="tech"
                      />
                    </div>
                  </div>
                  <h4><b><br>Algorithm walkthrough</b></h4>
                  <h5><b><br>Checking and Requesting Permissions</b></h5>
                  <p class="lead">In order to scan, discover and connect to BLE devices, one must ask for bluetooth & location permissions from the target device. 
                    PermissionsStatus is a Permissions class that allows the app to check and request permissions at run time, it is required for the functioning of this app.</p>
                    <pre><code>
                      public async Task<PermissionStatus> RequestBluetoothPermissions()
                        {
                            PermissionStatus status = PermissionStatus.Unknown;
                            try
                            {
                                status = await Permissions.RequestAsync<BluetoothPermissions>();
                            }
                    #if permission is denied an exception is caught
                            catch (Exception ex)
                            {
                                Console.WriteLine($"Unable to request Bluetooth LE permissions: {ex.Message}.");
                                await Shell.Current.DisplayAlert($"Unable to request Bluetooth LE permissions", $"{ex.Message}.", "OK");
                            }
                            return status
                    </code></pre>
                    <p class="lead">Check whether bluetooth permissions have been granted</p>
                    <pre><code>
        PermissionStatus permissionStatus = await BluetoothLEService.CheckBluetoothPermissions();
        if(permissionStatus != PermissionStatus.Granted)
        {
            permissionStatus = await BluetoothLEService.RequestBluetoothPermissions();
            if(permissionStatus != PermissionStatus.Granted)
            {
                await Shell.Current.DisplayAlert($"Bluetooth LE permissions", $"Bluetooth LE permissions are not granted.", "OK");
                return;
            }
        }
                    </code></pre>
                    <p class="lead"> Check whether bluetooth is one & available on the device</p>
                    <pre><code>
                     if (!BluetoothLEService.BluetoothLE.IsAvailable || BluetoothLEService.BluetoothLE.State != BluetoothState.On)
        {
            Console.WriteLine($"Bluetooth is missing.");
            await Shell.Current.DisplayAlert($"Bluetooth", $"Bluetooth is missing.", "OK");
            return;
        }
try
        {
            if (!BluetoothLEService.BluetoothLE.IsOn)
            {
                await Shell.Current.DisplayAlert($"Bluetooth is not on", $"Please turn Bluetooth on and try again.", "OK");
                return;
            }
                    </code></pre>
                    <h5><b><br>Starting scan</b></h5>
                    <p class="lead">Once the permissions have been accepted, the app can start scanning<br>
                      <i>deviceCandidates</i> represents the list of devices that have been discovered by the <i>BluetoothLEService.ScanForDevicesAsync()</i></p>
                      <pre><code>
          List<DeviceCandidate> deviceCandidates = await BluetoothLEService.ScanForDevicesAsync();
                      </code></pre>
                      <p class="lead">System will scan for 4 seconds before timing out</p>
                      <pre><code>
                        BluetoothLE = CrossBluetoothLE.Current;
                        Adapater = CrossBluetoothLE.Current.Adapater;
                        Adapter.ScanTimeout = 4000; //ms
                      </code></pre>
                      <div class="row">
                        <div class="d-flex justify-content-center mb-3">
                          <img src="img/sun.png" class="img-fluid shadow-sm" />
                        </div>
                      </div>
                      <p class="lead">If sensors/BLE devices are found the deviceCandidate list will be represented here as a grid of devices with 
                        each row being each devices name and Guid (global unique identifier)</p>
                        <br>
                        <pre><code>
                          &lt;DataTemplate x:DataType=&quot;model:DeviceCandidate&quot;&gt;
                          &lt;Grid Padding=&quot;10&quot;&gt;
                              &lt;Frame BorderColor=&quot;#DDDDDD&quot;
                                     HasShadow=&quot;True&quot;
                                     Padding=&quot;10&quot;
                                     Background=&quot;Black&quot;
                                     CornerRadius=&quot;10&quot;
                                     IsClippedToBounds=&quot;True&quot;&gt;
                          &lt;VerticalStackLayout Padding=&quot;8&quot;&gt;
                              &lt;Label Style=&quot;{StaticResource BaseLabel}&quot; Text=&quot;{Binding Name}&quot; /&gt;
                               &lt;Label Style=&quot;{StaticResource MicroLabel}&quot; Text=&quot;{Binding Id}&quot; /&gt;
                          &lt;/VerticalStackLayout&gt;
                              &lt;/Frame&gt;
                           &lt;/Grid&gt;
                        </code></pre>
                  <p class="lead">Once a sensor has been selected it will navigate to its correspondoning page (Heart/Sensor) and you will 
                    be given the ability to connect/disconnect (see above) </p>

                    <h5><b><br>Connectig to a device</b></h5>
                    <p class="lead">The adapter will connect to a device given a known global user identifier (Guid) which is 
                      extracted from BluetoothLSEService.NewDeviceCandidateFromHomePage.Id</p>
                      <pre><code>
BluetoothLSEService.Device = await 
BluetoothLSEService.Adapter.ConnectToKnownDeviceAsync(BluetoothLSEService.NewDeviceCandidateFromHomePage.Id);
                      </code></pre>
                    <h5><b><br>Disconnecting from a device </b></h5>
                    <p class="lead">Like before, the adapter will disconnect from a device given a known device name which is extracted from BluetoothLSEService.Device</p>
                      <pre><code>
await BluetoothLSEService.Adapter.DisconnectDeviceAsync(BluetoothLSEService.Device);
                      </code></pre>
                    <h5><b><br>Getting characteristics</b></h5>
                    <p class="lead">Once a connection has been made, the system can extract specific characterisitcs from the BLE device given general identifiers. Below are our full list of Guids stored in class HeartRateIdentifiers</p>
                      <pre><code>
class HeartRateIdentifiers

    {
    // primary service for heart rate 8CE5CC02-0A4D-11E9-AB14-D663BD873D93"
    //public static Guid HeartRateService = Guid.ParseExact("0000180d-0000-1000-8000-00805f9b34fb", "d");
    public static Guid[] HeartRateServiceUuids { get; private set; } = new Guid[] { new Guid("0000180d-0000-1000-8000-00805f9b34fb") }; //"Heart Rate Service"
    public static Guid HeartRateServiceUuid { get; private set; } = new Guid("0000180d-0000-1000-8000-00805f9b34fb"); //"Heart Rate Service"
    public static Guid HeartRateMeasurementCharacteristicUuid { get; private set; } = new Guid("00002a37-0000-1000-8000-00805f9b34fb"); //"Heart Rate Measurement"
    public static Guid BatteryLevelServiceUuid { get; private set; } = new Guid("0000180f-0000-1000-8000-00805f9b34fb"); //"Battery Service"
    public static Guid BatteryLevelCharacteristicUuid { get; private set; } = new Guid("00002a19-0000-1000-8000-00805f9b34fb"); //"Battery Level"
    }
                      </code></pre>
                      <p class="lead"> Heart rate information being extracted from heart sensor with provided characteristic Guids</p>
                      <pre><code>
 HeartRateMeasurementCharacteristic = await HeartRateService.GetCharacteristicAsync(HeartRateIdentifiers.HeartRateMeasurementCharacteristicUuid);
                      </code></pre>
                      <p class="lead">Given the heart rate updates throughout the workout, system must continously extract heart rate 
                        information from the sensor as long as there is a stable connection</p>
                      <pre><code>
                        if (HeartRateMeasurementCharacteristic.CanUpdate)
                        {
                            Title = $"{BluetoothLSEService.Device.Name}";

                            #region save device id to storage
                            await SecureStorage.Default.SetAsync("device_name", $"{BluetoothLSEService.Device.Name}");
                            await SecureStorage.Default.SetAsync("device_id", $"{BluetoothLSEService.Device.Id}");
                            #endregion save device id to storage

                            HeartRateMeasurementCharacteristic.ValueUpdated += HeartRateMeasurementCharacteristic_ValueUpdated;
                            await HeartRateMeasurementCharacteristic.StartUpdatesAsync();
                        } 
                      </code></pre>
            </div>
        </div>
      </section>



      <!--Footer-->
    </section>
    <section class="footer">
      <div class="social-links">
        <a href="https://github.com/BaneTrajkovic/Project-VeloCity"
          ><i class="fa-brands fa-github"></i
        ></a>
        <a href="https://projectvelocity2023.wordpress.com/"
          ><i class="fa-brands fa-wordpress"></i
        ></a>
      </div>

      <ul class="list">
        <li class="nav-item">
          <a href="/lit.html" class="nav-link">Research</a>
        </li>
        <li class="nav-item">
          <a href="/hci.html" class="nav-link">HCi</a>
        </li>
        <li class="nav-item">
          <a href="/index.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item">
          <a href="/requirements.html" class="nav-link">Requirements</a>
        </li>
        <li class="nav-item">
          <a href="/appendix.html" class="nav-link">Appendices</a>
        </li>
        <li class="nav-item">
          <a href="system.html" class="nav-link">System Design</a>
        </li>
      </ul>
      <p class="copyright">2023 All Rights Reserved</p>
    </section>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
      AOS.init();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
  </body>
</html>
